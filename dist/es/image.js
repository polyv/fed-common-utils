export const supportWebP=(()=>{let e;return()=>{if(null==e)try{e=function(){const e=document.createElement("canvas");if(e.getContext&&e.getContext("2d")){const t="image/webp";return 0===e.toDataURL(t).indexOf("data:"+t)}return!1}()||function(){let e=!1;const t=navigator.userAgent,A=/\bOS\s([\d_.]+)\slike\sMac\sOS\sX\b/.exec(t);if(A)e=parseInt(A[1])>=14;else{const A=/\bVersion\/([\d.]+)\sSafari\b/.exec(t);A&&(e=parseInt(A[1])>=16)}return e}()}catch(t){e=!1}return e}})();export const supportAVIF=(()=>{let e;return()=>(e||(e=new Promise((e=>{const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=",t.onerror=()=>{e(!1)},t.onload=()=>{e(!0)},setTimeout((()=>{e(!1)}),1e3)}))),e)})();function getExtname(e){const t=(e||"").split("."),A=t[t.length-1];return A?A.toLowerCase():""}function handleCompressOptions(e){var t,A;const n="number"==typeof e?{width:e}:e;return n.allowJPG=null===(t=n.allowJPG)||void 0===t||t,n.allowWebP=null!==(A=n.allowWebP)&&void 0!==A?A:"auto",n}function createURLObject(e){let t;if("undefined"!=typeof document){const A=document.createElement("a");A.href=e,t=A}else if("function"==typeof URL)try{t=new URL(/^\/\//.test(e)?"https:"+e:e)}catch(e){}return t}function genOSSCompressParams(e,t){let A="";return null==t.width&&null==t.height||(A+="/resize",t.width&&(A+=",w_"+t.width),t.height&&(A+=",h_"+t.height),A+=",limit_1"),t.allowAVIF&&"gif"!==e?A+="/format,avif":!0===t.allowWebP||"auto"===t.allowWebP&&supportWebP()?A+="/format,webp/quality,Q_80":t.allowJPG&&"gif"!==e&&(A+="/format,jpg/quality,Q_80"),A}function setOSSCompressParams(e,t){let A=!1;return e=e.replace(/([?&]x-oss-process)(?:=([^&]*))?/,((e,n,o)=>(A=!0,/^image/.test(o)?n+"="+o.replace(/\/(?:resize|format|quality)[^/]*/gi,"")+t:e))),A?e:e+(-1===e.indexOf("?")?"?":"&")+"x-oss-process=image"+t}export function ossCompress(e,t){const A=createURLObject(e);if(!A)return e;const n=getExtname(A.pathname.split("/").pop());if(!/\.videocc\.net$/i.test(A.hostname)||"svg"===n)return e;const o=genOSSCompressParams(n,handleCompressOptions(t));return o&&(A.search=setOSSCompressParams(A.search,o)),A.href}function genCOSCompressParams(e,t){let A="";return null!=t.width&&null!=t.height?A+=`/thumbnail/${t.width}x${t.height}`:null!=t.width?A+=`/thumbnail/${t.width}x`:null!=t.height&&(A+=`/thumbnail/x${t.height}`),t.allowAVIF&&"gif"!==e?A+="/format/avif":!0===t.allowWebP||"auto"===t.allowWebP&&supportWebP()?A+="/format/webp/quality/80":t.allowJPG&&"gif"!==e&&(A+="/format/jpg/quality/80"),A}function setCOSCompressParams(e,t){let A=!1;return e=e.replace(/([?&]imageMogr2)(\/[^&]*)/,((e,n,o)=>(A=!0,n+"="+o.replace(/\/(?:thumbnail|format|quality)\/[^/]+/gi,"")+t))),A?e:e+(-1===e.indexOf("?")?"?":"&")+"imageMogr2"+t}export function cosCompress(e,t){const A=createURLObject(e);if(!A)return e;const n=getExtname(A.pathname.split("/").pop());if(!/(?:\.videocc\.net|\.kingswayvideo\.com)$/i.test(A.hostname)||"svg"===n)return e;const o=genCOSCompressParams(n,handleCompressOptions(t));return o&&(A.search=setCOSCompressParams(A.search,o)),A.href}export function compressHTMLImgs(e,t,A=ossCompress){return e?e.replace(/(<img.*?\ssrc=)(["']?)(.+?)\2(.*?>)/gi,((e,n,o,r,s)=>n+'"'+A(r,t)+'" data-src="'+r+'"'+s)):""}export function preloadImg(e){return new Promise(((t,A)=>{const n=new Image;function o(){t({width:n.width,height:n.height,element:n})}n.onload=o,n.onerror=function(){A(new Error(`"${e}" load failed.`))},n.src=e,n.complete&&o()}))}